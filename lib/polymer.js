"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fspath = require("path");
const fs = require("fs");
const dopees_chain_1 = require("dopees-chain");
const dopees_chain_sass_1 = require("dopees-chain-sass");
const dopees_chain_pug_1 = require("dopees-chain-pug");
const dopees_chain_typescript_1 = require("dopees-chain-typescript");
const babel = require("@babel/core");
const traverse_1 = require("@babel/traverse");
const mkdirp = require("mkdirp");
const mkdirrec = (path) => new Promise((resolve, reject) => mkdirp(path, (err, res) => err ? reject(err) : resolve(res)));
const fsp = fs.promises;
const fsmtime = (path) => fsp.stat(path).then(stats => stats.mtime, () => null);
const toAbsolutePath = (path, base) => {
    if (fspath.isAbsolute(path)) {
        return fspath.normalize(path);
    }
    return fspath.normalize(fspath.join(base, path));
};
const findAllDependencies = (ast, action) => {
    return traverse_1.default(ast, {
        ImportDeclaration(path) {
            const node = path.node;
            action(node.source.value);
        },
        ExportDeclaration(path) {
            const node = path.node;
            if ('ExportNamedDeclaration' === node.type) {
                const n = node;
                if (n.source) {
                    action(n.source.value);
                }
            }
        }
    });
};
const keyDeepDependencies = 'polymer.deep.depepndencies';
async function resolveDeep(targetRoot, npmRoot, context, toCopy, path) {
    const mtime = await fsmtime(path);
    if (!mtime) {
        throw new Error(`failed to get mtime for ${path}`);
    }
    let deps;
    const entry = await context.storage.getObject(`!${keyDeepDependencies}!${path}`);
    if (entry && entry.mtime >= mtime) {
        deps = entry.deps;
    }
    else {
        // already parsed?
        let ast;
        const entry = await context.storage.getObject(`!polymer.deep.ast!${path}`);
        if (entry && entry.mtime >= mtime) {
            ast = entry.ast;
        }
        else {
            const babelOptions = {
                filename: path,
                ast: true,
                root: npmRoot,
                rootMode: 'root',
                plugins: ['@babel/syntax-dynamic-import'],
                parserOpts: {
                    sourceType: 'module'
                }
            };
            const sourceCode = await context.getContents(dopees_chain_1.Task.file(path), 'utf-8');
            ast = await babel.parseAsync(sourceCode, babelOptions);
            await context.storage.setObject(`!polymer.deep.ast!${path}`, { mtime, ast });
        }
        // get dependencies
        deps = [];
        findAllDependencies(ast, dep => deps.push(dep));
        await context.storage.setObject(`!${keyDeepDependencies}!${path}`, { mtime, deps });
    }
    // process dependencies
    const deepDependencies = [];
    for (const localPath of deps) {
        if (localPath.startsWith('./') || localPath.startsWith('../')) {
            // in-package dependency
            let source = fspath.normalize(fspath.join(fspath.dirname(path), localPath));
            if (!source.endsWith('.js')) {
                source += '.js';
            }
            if (!toCopy.some(e => e.source === source)) {
                const target = fspath.normalize(fspath.join(targetRoot, fspath.relative(npmRoot, source)));
                toCopy.push({ source, target });
                deepDependencies.push(source);
            }
        }
        else {
            // external dependency
            let source = fspath.normalize(fspath.join(npmRoot, localPath));
            if (!source.endsWith('.js')) {
                source += '.js';
            }
            if (!toCopy.some(e => e.source === source)) {
                let target = fspath.normalize(fspath.join(targetRoot, fspath.relative(npmRoot, source)));
                // same folder dependencies must start with './'
                if (!target.startsWith('..')) {
                    target = './' + target;
                }
                toCopy.push({ source, target });
                deepDependencies.push(source);
            }
        }
    }
    // trigger deep resolve
    await Promise.all(deepDependencies.map(path => resolveDeep(targetRoot, npmRoot, context, toCopy, path)));
}
function unique(source) {
    const result = [];
    for (const item of source) {
        if (!result.some(i => i === item)) {
            result.push(item);
        }
    }
    return result;
}
function deploy(opts) {
    const { targetRoot, buildTaskName, allDependenciesKey } = opts;
    return async (task, context) => {
        if (task.name instanceof dopees_chain_1.LogicalName && task.name.name === buildTaskName) {
            const deps = await context.storage.getObject(allDependenciesKey);
            if (!deps) {
                throw new Error('no dependencies has been populated');
            }
            const root = context.basePath;
            const npmRoot = fspath.join(root, 'node_modules');
            // flatten dependencies
            const toCopy = [];
            // const imports: Array<{ name: string, target: string }> = [];
            context.log('deploy', task, 'resolving source dependencies...');
            const allSources = unique(deps.map(dep => dep.source));
            for (const entry of deps) {
                for (const dep of entry.dependencies) {
                    const possibleSource = fspath.normalize(fspath.join(fspath.dirname(entry.source), dep));
                    if (!allSources.some(x => x === possibleSource)) {
                        const dependency = fspath.relative(targetRoot, possibleSource);
                        let mtime;
                        // try js in modules
                        let candidate = fspath.join(npmRoot, dependency);
                        mtime = await fsmtime(candidate);
                        if (!mtime) {
                            throw new Error(`unable to resolve ${dependency}`);
                        }
                        const target = fspath.join(targetRoot, dependency);
                        toCopy.push({
                            source: candidate,
                            target
                        });
                    }
                }
            }
            // context.log('deploy', task, 'done updating dependency imports');
            context.log('deploy', task, 'done resolving source dependencies');
            // resolve deep dependencies
            context.log('deploy', task, 'resolving deep dependencies...');
            await Promise.all(toCopy.map(e => resolveDeep(targetRoot, npmRoot, context, toCopy, e.source)));
            context.log('deploy', task, 'done resolving deep dependencies');
            // copy dependencies
            context.log('deploy', task, 'copying dependencies...');
            const created = new Set();
            await Promise.all(toCopy.map(async (e) => {
                const folder = fspath.dirname(e.target);
                if (!created.has(folder)) {
                    await mkdirrec(folder);
                    created.add(folder);
                }
                await fsp.copyFile(e.source, e.target);
            }));
            context.log('deploy', task, 'done copying dependencies');
        }
    };
}
class PolymerProject {
    constructor(config) {
        this.taskName = 'dopees-polymer';
        this.cwd = config.cwd || process.cwd();
        this.buildRoot = toAbsolutePath(config.buildRoot || './.build', this.cwd);
        this.sourceRoot = toAbsolutePath(config.sourceRoot, this.cwd);
        this.targetRoot = toAbsolutePath(config.targetRoot, this.cwd);
        this.application = config.application !== false;
    }
    async getTargets() {
        const targets = [];
        const traverse = async (subpath) => {
            const names = await fsp.readdir(fspath.join(this.sourceRoot, subpath));
            for (const name of names) {
                const sourcePath = fspath.normalize(fspath.join(this.sourceRoot, subpath, name));
                const stats = await fsp.stat(sourcePath).catch(() => null);
                if (stats) {
                    if (stats.isDirectory()) {
                        await traverse(fspath.normalize(fspath.join(subpath, name)));
                    }
                    else if (sourcePath.endsWith('.ts') && !sourcePath.endsWith('.d.ts')) {
                        const targetPath = fspath.normalize(fspath.join(this.targetRoot, fspath.relative(this.sourceRoot, sourcePath))).replace(/\.ts$/, '.js');
                        targets.push({ path: targetPath, base: this.cwd });
                    }
                }
            }
        };
        await traverse('.');
        return targets;
    }
    createExecutor() {
        const pugSourceResolver = dopees_chain_1.ReversePathResolver.from({
            sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
            targetRoot: fspath.relative(this.cwd, this.buildRoot),
            sourceExt: 'pug',
            targetExt: 'html'
        });
        const executors = [
            dopees_chain_sass_1.sass({
                sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
                targetRoot: fspath.relative(this.cwd, this.buildRoot),
                sourceExt: 'scss',
                targetExt: 'css',
                outputStyle: 'compressed'
            }),
            dopees_chain_pug_1.pug({
                inlineCss: true,
                targetRoot: fspath.relative(this.cwd, this.buildRoot),
                sourceResolver: (path, base) => {
                    const source = pugSourceResolver(path, base);
                    if (!source) {
                        throw new Error(`unable to resolve source for ${path} (base = ${base})`);
                    }
                    return source;
                }
            }),
            dopees_chain_typescript_1.dopees({
                sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
                buildRoot: fspath.relative(this.cwd, this.buildRoot),
                targetRoot: fspath.relative(this.cwd, this.targetRoot),
                saveAllDependencies: true,
                allDependenciesKey: 'dopees.polymer.dependencies',
                updateExternalImports: this.application
            }),
            async (task, context) => {
                if (task.name instanceof dopees_chain_1.LogicalName && task.name.name === this.taskName) {
                    const targets = await this.getTargets();
                    await Promise.all(targets.map(target => context.execute(dopees_chain_1.Task.file(target.path, target.base))));
                }
            }
        ];
        if (this.application) {
            executors.push(deploy({
                targetRoot: this.targetRoot,
                allDependenciesKey: 'dopees.polymer.dependencies',
                buildTaskName: this.taskName
            }));
        }
        return dopees_chain_1.Executors.combine(executors);
    }
}
exports.PolymerProject = PolymerProject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9seW1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wb2x5bWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QiwrQ0FBb0c7QUFDcEcseURBQXlDO0FBQ3pDLHVEQUF1QztBQUN2QyxxRUFBa0U7QUFFbEUscUNBQXFDO0FBQ3JDLDhDQUF1QztBQUN2QyxpQ0FBaUM7QUFFakMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxJQUFZLEVBQXdCLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV4SixNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDO0FBRXhCLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFXeEYsTUFBTSxjQUFjLEdBQUcsQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLEVBQUU7SUFDcEQsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzNCLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMvQjtJQUNELE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ25E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O29CQUN4QyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsbUJBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ2hHO1lBQ0gsQ0FBQztTQUNGLENBQUM7UUFDRixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ3BCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtnQkFDM0Isa0JBQWtCLEVBQUUsNkJBQTZCO2dCQUNqRCxhQUFhLEVBQUUsSUFBSSxDQUFDLFFBQVE7YUFDN0IsQ0FBQyxDQUFDLENBQUM7U0FDTDtRQUNELE9BQU8sd0JBQVMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBekZELHdDQXlGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEV4ZWN1dG9yLCBFeGVjdXRvcnMsIFJldmVyc2VQYXRoUmVzb2x2ZXIsIFRhc2ssIENvbnRleHQsIExvZ2ljYWxOYW1lIH0gZnJvbSAnZG9wZWVzLWNoYWluJztcbmltcG9ydCB7IHNhc3MgfSBmcm9tICdkb3BlZXMtY2hhaW4tc2Fzcyc7XG5pbXBvcnQgeyBwdWcgfSBmcm9tICdkb3BlZXMtY2hhaW4tcHVnJztcbmltcG9ydCB7IGRvcGVlcywgRGVwZW5kZW5jeUVudHJ5IH0gZnJvbSAnZG9wZWVzLWNoYWluLXR5cGVzY3JpcHQnO1xuaW1wb3J0ICogYXMgdCBmcm9tICdAYmFiZWwvdHlwZXMnO1xuaW1wb3J0ICogYXMgYmFiZWwgZnJvbSAnQGJhYmVsL2NvcmUnO1xuaW1wb3J0IHRyYXZlcnNlIGZyb20gJ0BiYWJlbC90cmF2ZXJzZSc7XG5pbXBvcnQgKiBhcyBta2RpcnAgZnJvbSAnbWtkaXJwJztcblxuY29uc3QgbWtkaXJyZWMgPSAocGF0aDogc3RyaW5nKTogUHJvbWlzZTxta2RpcnAuTWFkZT4gPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gbWtkaXJwKHBhdGgsIChlcnIsIHJlcykgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKHJlcykpKTtcblxuY29uc3QgZnNwID0gZnMucHJvbWlzZXM7XG5cbmNvbnN0IGZzbXRpbWUgPSAocGF0aDogc3RyaW5nKSA9PiBmc3Auc3RhdChwYXRoKS50aGVuKHN0YXRzID0+IHN0YXRzLm10aW1lLCAoKSA9PiBudWxsKTtcblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgc291cmNlUm9vdDogc3RyaW5nO1xuICB0YXJnZXRSb290OiBzdHJpbmc7XG4gIGJ1aWxkUm9vdD86IHN0cmluZztcbiAgY3dkPzogc3RyaW5nO1xuICAvKiogV2hlbiBfdHJ1ZV8gYWxsIGRlZXAgZGVwZW5kZW5jaWVzIGFyZSByZXdyaXR0ZW4gd2l0aCByZXNwb2N0IHRvIHRoZSB0YXJnZXQgZGlyZWN0b3J5LiAqL1xuICBhcHBsaWNhdGlvbj86IGJvb2xlYW47XG59XG5cbmNvbnN0IHRvQWJzb2x1dGVQYXRoID0gKHBhdGg6IHN0cmluZywgYmFzZTogc3RyaW5nKSA9PiB7XG4gIGlmIChmc3BhdGguaXNBYnNvbHV0ZShwYXRoKSkge1xuICAgIHJldHVybiBmc3BhdGgubm9ybWFsaXplKHBhdGgpO1xuICB9XG4gIHJldHVybiBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKGJhc2UsIHBhdGgpKTtcbn1cblxuaW50ZXJmYWNlIFRhcmdldCB7XG4gIHBhdGg6IHN0cmluZztcbiAgYmFzZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgRGVwbG95T3B0aW9ucyB7XG4gIHRhcmdldFJvb3Q6IHN0cmluZztcbiAgYnVpbGRUYXNrTmFtZTogc3RyaW5nO1xuICBhbGxEZXBlbmRlbmNpZXNLZXk6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIERlZXBEZXBlbmRlbmNpZXMge1xuICBtdGltZTogRGF0ZSxcbiAgZGVwczogc3RyaW5nW11cbn1cblxuaW50ZXJmYWNlIENhY2hlZEFzdCB7XG4gIG10aW1lOiBEYXRlLFxuICBhc3Q6IHQuTm9kZVxufVxuXG5jb25zdCBmaW5kQWxsRGVwZW5kZW5jaWVzID0gKGFzdDogdC5Ob2RlLCBhY3Rpb246IChzb3VyY2U6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICByZXR1cm4gdHJhdmVyc2UoYXN0LCB7XG4gICAgSW1wb3J0RGVjbGFyYXRpb24ocGF0aCkge1xuICAgICAgY29uc3Qgbm9kZSA9IHBhdGgubm9kZTtcbiAgICAgIGFjdGlvbihub2RlLnNvdXJjZS52YWx1ZSk7XG4gICAgfSxcbiAgICBFeHBvcnREZWNsYXJhdGlvbihwYXRoKSB7XG4gICAgICBjb25zdCBub2RlID0gcGF0aC5ub2RlO1xuICAgICAgaWYgKCdFeHBvcnROYW1lZERlY2xhcmF0aW9uJyA9PT0gbm9kZS50eXBlKSB7XG4gICAgICAgIGNvbnN0IG4gPSA8dC5FeHBvcnROYW1lZERlY2xhcmF0aW9uPm5vZGU7XG4gICAgICAgIGlmIChuLnNvdXJjZSkge1xuICAgICAgICAgIGFjdGlvbihuLnNvdXJjZS52YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufTtcblxuY29uc3Qga2V5RGVlcERlcGVuZGVuY2llcyA9ICdwb2x5bWVyLmRlZXAuZGVwZXBuZGVuY2llcyc7XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc29sdmVEZWVwKHRhcmdldFJvb3Q6IHN0cmluZywgbnBtUm9vdDogc3RyaW5nLCBjb250ZXh0OiBDb250ZXh0LCB0b0NvcHk6IEFycmF5PHsgc291cmNlOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nIH0+LCBwYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgbXRpbWUgPSBhd2FpdCBmc210aW1lKHBhdGgpO1xuICBpZiAoIW10aW1lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBmYWlsZWQgdG8gZ2V0IG10aW1lIGZvciAke3BhdGh9YCk7XG4gIH1cbiAgbGV0IGRlcHM6IHN0cmluZ1tdO1xuICBjb25zdCBlbnRyeSA9IGF3YWl0IGNvbnRleHQuc3RvcmFnZS5nZXRPYmplY3Q8RGVlcERlcGVuZGVuY2llcz4oYCEke2tleURlZXBEZXBlbmRlbmNpZXN9ISR7cGF0aH1gKTtcbiAgaWYgKGVudHJ5ICYmIGVudHJ5Lm10aW1lID49IG10aW1lKSB7XG4gICAgZGVwcyA9IGVudHJ5LmRlcHM7XG4gIH0gZWxzZSB7XG4gICAgLy8gYWxyZWFkeSBwYXJzZWQ/XG4gICAgbGV0IGFzdDogdC5Ob2RlO1xuICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgY29udGV4dC5zdG9yYWdlLmdldE9iamVjdDxDYWNoZWRBc3Q+KGAhcG9seW1lci5kZWVwLmFzdCEke3BhdGh9YCk7XG4gICAgaWYgKGVudHJ5ICYmIGVudHJ5Lm10aW1lID49IG10aW1lKSB7XG4gICAgICBhc3QgPSBlbnRyeS5hc3Q7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJhYmVsT3B0aW9ucyA6IGJhYmVsLk9wdGlvbnMgPSB7XG4gICAgICAgIGZpbGVuYW1lOiBwYXRoLFxuICAgICAgICBhc3Q6IHRydWUsXG4gICAgICAgIHJvb3Q6IG5wbVJvb3QsXG4gICAgICAgIHJvb3RNb2RlOiAncm9vdCcsXG4gICAgICAgIHBsdWdpbnM6IFsnQGJhYmVsL3N5bnRheC1keW5hbWljLWltcG9ydCddLFxuICAgICAgICBwYXJzZXJPcHRzOiB7XG4gICAgICAgICAgc291cmNlVHlwZTogJ21vZHVsZSdcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGNvbnN0IHNvdXJjZUNvZGUgPSBhd2FpdCBjb250ZXh0LmdldENvbnRlbnRzKFRhc2suZmlsZShwYXRoKSwgJ3V0Zi04Jyk7XG4gICAgICBhc3QgPSBhd2FpdCBiYWJlbC5wYXJzZUFzeW5jKHNvdXJjZUNvZGUsIGJhYmVsT3B0aW9ucyk7XG4gICAgICBhd2FpdCBjb250ZXh0LnN0b3JhZ2Uuc2V0T2JqZWN0KGAhcG9seW1lci5kZWVwLmFzdCEke3BhdGh9YCwgPENhY2hlZEFzdD57IG10aW1lLCBhc3QgfSk7XG4gICAgfVxuICAgIC8vIGdldCBkZXBlbmRlbmNpZXNcbiAgICBkZXBzID0gW107XG4gICAgZmluZEFsbERlcGVuZGVuY2llcyhhc3QsIGRlcCA9PiBkZXBzLnB1c2goZGVwKSk7XG4gICAgYXdhaXQgY29udGV4dC5zdG9yYWdlLnNldE9iamVjdChgISR7a2V5RGVlcERlcGVuZGVuY2llc30hJHtwYXRofWAsIDxEZWVwRGVwZW5kZW5jaWVzPnsgbXRpbWUsIGRlcHMgfSk7XG4gIH1cbiAgLy8gcHJvY2VzcyBkZXBlbmRlbmNpZXNcbiAgY29uc3QgZGVlcERlcGVuZGVuY2llczogc3RyaW5nW10gPSBbXTtcbiAgZm9yIChjb25zdCBsb2NhbFBhdGggb2YgZGVwcykge1xuICAgIGlmIChsb2NhbFBhdGguc3RhcnRzV2l0aCgnLi8nKSB8fCBsb2NhbFBhdGguc3RhcnRzV2l0aCgnLi4vJykpIHtcbiAgICAgIC8vIGluLXBhY2thZ2UgZGVwZW5kZW5jeVxuICAgICAgbGV0IHNvdXJjZSA9IGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4oZnNwYXRoLmRpcm5hbWUocGF0aCksIGxvY2FsUGF0aCkpO1xuICAgICAgaWYgKCFzb3VyY2UuZW5kc1dpdGgoJy5qcycpKSB7XG4gICAgICAgIHNvdXJjZSArPSAnLmpzJztcbiAgICAgIH1cbiAgICAgIGlmICghdG9Db3B5LnNvbWUoZSA9PiBlLnNvdXJjZSA9PT0gc291cmNlKSkge1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKHRhcmdldFJvb3QsIGZzcGF0aC5yZWxhdGl2ZShucG1Sb290LCBzb3VyY2UpKSk7XG4gICAgICAgIHRvQ29weS5wdXNoKHsgc291cmNlLCB0YXJnZXQgfSk7XG4gICAgICAgIGRlZXBEZXBlbmRlbmNpZXMucHVzaChzb3VyY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBleHRlcm5hbCBkZXBlbmRlbmN5XG4gICAgICBsZXQgc291cmNlID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbihucG1Sb290LCBsb2NhbFBhdGgpKTtcbiAgICAgIGlmICghc291cmNlLmVuZHNXaXRoKCcuanMnKSkge1xuICAgICAgICBzb3VyY2UgKz0gJy5qcyc7XG4gICAgICB9XG4gICAgICBpZiAoIXRvQ29weS5zb21lKGUgPT4gZS5zb3VyY2UgPT09IHNvdXJjZSkpIHtcbiAgICAgICAgbGV0IHRhcmdldCA9IGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4odGFyZ2V0Um9vdCwgZnNwYXRoLnJlbGF0aXZlKG5wbVJvb3QsIHNvdXJjZSkpKTtcbiAgICAgICAgLy8gc2FtZSBmb2xkZXIgZGVwZW5kZW5jaWVzIG11c3Qgc3RhcnQgd2l0aCAnLi8nXG4gICAgICAgIGlmICghdGFyZ2V0LnN0YXJ0c1dpdGgoJy4uJykpIHtcbiAgICAgICAgICB0YXJnZXQgPSAnLi8nICsgdGFyZ2V0O1xuICAgICAgICB9XG4gICAgICAgIHRvQ29weS5wdXNoKHsgc291cmNlLCB0YXJnZXQgfSk7XG4gICAgICAgIGRlZXBEZXBlbmRlbmNpZXMucHVzaChzb3VyY2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICAvLyB0cmlnZ2VyIGRlZXAgcmVzb2x2ZVxuICBhd2FpdCBQcm9taXNlLmFsbChkZWVwRGVwZW5kZW5jaWVzLm1hcChwYXRoID0+IHJlc29sdmVEZWVwKHRhcmdldFJvb3QsIG5wbVJvb3QsIGNvbnRleHQsIHRvQ29weSwgcGF0aCkpKTtcbn1cblxuZnVuY3Rpb24gdW5pcXVlPFQ+KHNvdXJjZTogVFtdKTogVFtdIHtcbiAgY29uc3QgcmVzdWx0OiBUW10gPSBbXTtcbiAgZm9yIChjb25zdCBpdGVtIG9mIHNvdXJjZSkge1xuICAgIGlmICghcmVzdWx0LnNvbWUoaSA9PiBpID09PSBpdGVtKSkge1xuICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGRlcGxveShvcHRzOiBEZXBsb3lPcHRpb25zKTogRXhlY3V0b3Ige1xuICBjb25zdCB7IHRhcmdldFJvb3QsIGJ1aWxkVGFza05hbWUsIGFsbERlcGVuZGVuY2llc0tleSB9ID0gb3B0cztcbiAgcmV0dXJuIGFzeW5jICh0YXNrOiBUYXNrLCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgaWYgKHRhc2submFtZSBpbnN0YW5jZW9mIExvZ2ljYWxOYW1lICYmIHRhc2submFtZS5uYW1lID09PSBidWlsZFRhc2tOYW1lKSB7XG4gICAgICBjb25zdCBkZXBzID0gYXdhaXQgY29udGV4dC5zdG9yYWdlLmdldE9iamVjdDxEZXBlbmRlbmN5RW50cnlbXT4oYWxsRGVwZW5kZW5jaWVzS2V5KTtcbiAgICAgIGlmICghZGVwcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIGRlcGVuZGVuY2llcyBoYXMgYmVlbiBwb3B1bGF0ZWQnKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJvb3QgPSBjb250ZXh0LmJhc2VQYXRoO1xuICAgICAgY29uc3QgbnBtUm9vdCA9IGZzcGF0aC5qb2luKHJvb3QsICdub2RlX21vZHVsZXMnKTtcbiAgICAgIC8vIGZsYXR0ZW4gZGVwZW5kZW5jaWVzXG4gICAgICBjb25zdCB0b0NvcHk6IEFycmF5PHsgc291cmNlOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nIH0+ID0gW107XG4gICAgICAvLyBjb25zdCBpbXBvcnRzOiBBcnJheTx7IG5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcgfT4gPSBbXTtcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAncmVzb2x2aW5nIHNvdXJjZSBkZXBlbmRlbmNpZXMuLi4nKTtcbiAgICAgIGNvbnN0IGFsbFNvdXJjZXMgPSB1bmlxdWUoZGVwcy5tYXAoZGVwID0+IGRlcC5zb3VyY2UpKTtcbiAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgZGVwcykge1xuICAgICAgICBmb3IgKGNvbnN0IGRlcCBvZiBlbnRyeS5kZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICBjb25zdCBwb3NzaWJsZVNvdXJjZSA9IGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4oZnNwYXRoLmRpcm5hbWUoZW50cnkuc291cmNlKSwgZGVwKSk7XG4gICAgICAgICAgaWYgKCFhbGxTb3VyY2VzLnNvbWUoeCA9PiB4ID09PSBwb3NzaWJsZVNvdXJjZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBmc3BhdGgucmVsYXRpdmUodGFyZ2V0Um9vdCwgcG9zc2libGVTb3VyY2UpO1xuICAgICAgICAgICAgbGV0IG10aW1lIDogRGF0ZXxudWxsO1xuICAgICAgICAgICAgLy8gdHJ5IGpzIGluIG1vZHVsZXNcbiAgICAgICAgICAgIGxldCBjYW5kaWRhdGUgPSBmc3BhdGguam9pbihucG1Sb290LCBkZXBlbmRlbmN5KTtcbiAgICAgICAgICAgIG10aW1lID0gYXdhaXQgZnNtdGltZShjYW5kaWRhdGUpO1xuICAgICAgICAgICAgaWYgKCFtdGltZSkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byByZXNvbHZlICR7ZGVwZW5kZW5jeX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IGZzcGF0aC5qb2luKHRhcmdldFJvb3QsIGRlcGVuZGVuY3kpO1xuICAgICAgICAgICAgdG9Db3B5LnB1c2goe1xuICAgICAgICAgICAgICBzb3VyY2U6IGNhbmRpZGF0ZSxcbiAgICAgICAgICAgICAgdGFyZ2V0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAnZG9uZSB1cGRhdGluZyBkZXBlbmRlbmN5IGltcG9ydHMnKTtcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAnZG9uZSByZXNvbHZpbmcgc291cmNlIGRlcGVuZGVuY2llcycpO1xuICAgICAgLy8gcmVzb2x2ZSBkZWVwIGRlcGVuZGVuY2llc1xuICAgICAgY29udGV4dC5sb2coJ2RlcGxveScsIHRhc2ssICdyZXNvbHZpbmcgZGVlcCBkZXBlbmRlbmNpZXMuLi4nKTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRvQ29weS5tYXAoZSA9PiByZXNvbHZlRGVlcCh0YXJnZXRSb290LCBucG1Sb290LCBjb250ZXh0LCB0b0NvcHksIGUuc291cmNlKSkpO1xuICAgICAgY29udGV4dC5sb2coJ2RlcGxveScsIHRhc2ssICdkb25lIHJlc29sdmluZyBkZWVwIGRlcGVuZGVuY2llcycpO1xuICAgICAgLy8gY29weSBkZXBlbmRlbmNpZXNcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAnY29weWluZyBkZXBlbmRlbmNpZXMuLi4nKTtcbiAgICAgIGNvbnN0IGNyZWF0ZWQgPSBuZXcgU2V0KCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh0b0NvcHkubWFwKGFzeW5jIGUgPT4ge1xuICAgICAgICBjb25zdCBmb2xkZXIgPSBmc3BhdGguZGlybmFtZShlLnRhcmdldCk7XG4gICAgICAgIGlmICghY3JlYXRlZC5oYXMoZm9sZGVyKSkge1xuICAgICAgICAgIGF3YWl0IG1rZGlycmVjKGZvbGRlcik7XG4gICAgICAgICAgY3JlYXRlZC5hZGQoZm9sZGVyKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBmc3AuY29weUZpbGUoZS5zb3VyY2UsIGUudGFyZ2V0KTtcbiAgICAgIH0pKTtcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAnZG9uZSBjb3B5aW5nIGRlcGVuZGVuY2llcycpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUG9seW1lclByb2plY3Qge1xuICBzb3VyY2VSb290OiBzdHJpbmc7XG4gIHRhcmdldFJvb3Q6IHN0cmluZztcbiAgYnVpbGRSb290OiBzdHJpbmc7XG4gIGN3ZDogc3RyaW5nO1xuICBhcHBsaWNhdGlvbjogYm9vbGVhbjtcbiAgdGFza05hbWUgPSAnZG9wZWVzLXBvbHltZXInO1xuICBjb25zdHJ1Y3Rvcihjb25maWc6IE9wdGlvbnMpIHtcbiAgICB0aGlzLmN3ZCA9IGNvbmZpZy5jd2QgfHwgcHJvY2Vzcy5jd2QoKTtcbiAgICB0aGlzLmJ1aWxkUm9vdCA9IHRvQWJzb2x1dGVQYXRoKGNvbmZpZy5idWlsZFJvb3QgfHwgJy4vLmJ1aWxkJywgdGhpcy5jd2QpO1xuICAgIHRoaXMuc291cmNlUm9vdCA9IHRvQWJzb2x1dGVQYXRoKGNvbmZpZy5zb3VyY2VSb290LCB0aGlzLmN3ZCk7XG4gICAgdGhpcy50YXJnZXRSb290ID0gdG9BYnNvbHV0ZVBhdGgoY29uZmlnLnRhcmdldFJvb3QsIHRoaXMuY3dkKTtcbiAgICB0aGlzLmFwcGxpY2F0aW9uID0gY29uZmlnLmFwcGxpY2F0aW9uICE9PSBmYWxzZTtcbiAgfVxuICBwcml2YXRlIGFzeW5jIGdldFRhcmdldHMoKSB7XG4gICAgY29uc3QgdGFyZ2V0cyA6IFRhcmdldFtdID0gW107XG4gICAgY29uc3QgdHJhdmVyc2UgPSBhc3luYyAoc3VicGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBuYW1lcyA9IGF3YWl0IGZzcC5yZWFkZGlyKGZzcGF0aC5qb2luKHRoaXMuc291cmNlUm9vdCwgc3VicGF0aCkpO1xuICAgICAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB7XG4gICAgICAgIGNvbnN0IHNvdXJjZVBhdGggPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKHRoaXMuc291cmNlUm9vdCwgc3VicGF0aCwgbmFtZSkpO1xuICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzcC5zdGF0KHNvdXJjZVBhdGgpLmNhdGNoKCgpID0+IG51bGwpO1xuICAgICAgICBpZiAoc3RhdHMpIHtcbiAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgYXdhaXQgdHJhdmVyc2UoZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbihzdWJwYXRoLCBuYW1lKSkpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlUGF0aC5lbmRzV2l0aCgnLnRzJykgJiYgIXNvdXJjZVBhdGguZW5kc1dpdGgoJy5kLnRzJykpIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBhdGggPSBmc3BhdGgubm9ybWFsaXplKFxuICAgICAgICAgICAgICBmc3BhdGguam9pbihcbiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFJvb3QsXG4gICAgICAgICAgICAgICAgZnNwYXRoLnJlbGF0aXZlKHRoaXMuc291cmNlUm9vdCwgc291cmNlUGF0aClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKS5yZXBsYWNlKC9cXC50cyQvLCAnLmpzJyk7XG4gICAgICAgICAgICB0YXJnZXRzLnB1c2goeyBwYXRoOiB0YXJnZXRQYXRoLCBiYXNlOiB0aGlzLmN3ZCB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIGF3YWl0IHRyYXZlcnNlKCcuJyk7XG4gICAgcmV0dXJuIHRhcmdldHM7XG4gIH1cbiAgY3JlYXRlRXhlY3V0b3IoKTogRXhlY3V0b3Ige1xuICAgIGNvbnN0IHB1Z1NvdXJjZVJlc29sdmVyID0gUmV2ZXJzZVBhdGhSZXNvbHZlci5mcm9tKHtcbiAgICAgIHNvdXJjZVJvb3Q6IGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5zb3VyY2VSb290KSxcbiAgICAgIHRhcmdldFJvb3Q6IGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5idWlsZFJvb3QpLFxuICAgICAgc291cmNlRXh0OiAncHVnJyxcbiAgICAgIHRhcmdldEV4dDogJ2h0bWwnXG4gICAgfSk7XG4gICAgY29uc3QgZXhlY3V0b3JzID0gW1xuICAgICAgc2Fzcyh7XG4gICAgICAgIHNvdXJjZVJvb3Q6IGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5zb3VyY2VSb290KSxcbiAgICAgICAgdGFyZ2V0Um9vdDogZnNwYXRoLnJlbGF0aXZlKHRoaXMuY3dkLCB0aGlzLmJ1aWxkUm9vdCksXG4gICAgICAgIHNvdXJjZUV4dDogJ3Njc3MnLFxuICAgICAgICB0YXJnZXRFeHQ6ICdjc3MnLFxuICAgICAgICBvdXRwdXRTdHlsZTogJ2NvbXByZXNzZWQnXG4gICAgICB9KSxcbiAgICAgIHB1Zyh7XG4gICAgICAgIGlubGluZUNzczogdHJ1ZSxcbiAgICAgICAgdGFyZ2V0Um9vdDogZnNwYXRoLnJlbGF0aXZlKHRoaXMuY3dkLCB0aGlzLmJ1aWxkUm9vdCksXG4gICAgICAgIHNvdXJjZVJlc29sdmVyOiAocGF0aDogc3RyaW5nLCBiYXNlPzogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgY29uc3Qgc291cmNlID0gcHVnU291cmNlUmVzb2x2ZXIocGF0aCwgYmFzZSk7XG4gICAgICAgICAgaWYgKCFzb3VyY2UpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5hYmxlIHRvIHJlc29sdmUgc291cmNlIGZvciAke3BhdGh9IChiYXNlID0gJHtiYXNlfSlgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHNvdXJjZTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBkb3BlZXMoe1xuICAgICAgICBzb3VyY2VSb290OiBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMuc291cmNlUm9vdCksXG4gICAgICAgIGJ1aWxkUm9vdDogIGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5idWlsZFJvb3QpLFxuICAgICAgICB0YXJnZXRSb290OiBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMudGFyZ2V0Um9vdCksXG4gICAgICAgIHNhdmVBbGxEZXBlbmRlbmNpZXM6IHRydWUsXG4gICAgICAgIGFsbERlcGVuZGVuY2llc0tleTogJ2RvcGVlcy5wb2x5bWVyLmRlcGVuZGVuY2llcycsXG4gICAgICAgIHVwZGF0ZUV4dGVybmFsSW1wb3J0czogdGhpcy5hcHBsaWNhdGlvblxuICAgICAgfSksXG4gICAgICBhc3luYyAodGFzazogVGFzaywgY29udGV4dDogQ29udGV4dCkgPT4ge1xuICAgICAgICBpZiAodGFzay5uYW1lIGluc3RhbmNlb2YgTG9naWNhbE5hbWUgJiYgdGFzay5uYW1lLm5hbWUgPT09IHRoaXMudGFza05hbWUpIHtcbiAgICAgICAgICBjb25zdCB0YXJnZXRzID0gYXdhaXQgdGhpcy5nZXRUYXJnZXRzKCk7XG4gICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodGFyZ2V0cy5tYXAodGFyZ2V0ID0+IGNvbnRleHQuZXhlY3V0ZShUYXNrLmZpbGUodGFyZ2V0LnBhdGgsIHRhcmdldC5iYXNlKSkpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIF07XG4gICAgaWYgKHRoaXMuYXBwbGljYXRpb24pIHtcbiAgICAgIGV4ZWN1dG9ycy5wdXNoKGRlcGxveSh7XG4gICAgICAgIHRhcmdldFJvb3Q6IHRoaXMudGFyZ2V0Um9vdCxcbiAgICAgICAgYWxsRGVwZW5kZW5jaWVzS2V5OiAnZG9wZWVzLnBvbHltZXIuZGVwZW5kZW5jaWVzJyxcbiAgICAgICAgYnVpbGRUYXNrTmFtZTogdGhpcy50YXNrTmFtZVxuICAgICAgfSkpO1xuICAgIH1cbiAgICByZXR1cm4gRXhlY3V0b3JzLmNvbWJpbmUoZXhlY3V0b3JzKTtcbiAgfVxufSJdfQ==