"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fspath = require("path");
const fs = require("fs");
const dopees_chain_1 = require("dopees-chain");
const dopees_chain_sass_1 = require("dopees-chain-sass");
const dopees_chain_pug_1 = require("dopees-chain-pug");
const dopees_chain_typescript_1 = require("dopees-chain-typescript");
const babel = require("@babel/core");
const traverse_1 = require("@babel/traverse");
const mkdirp = require("mkdirp");
const mkdirrec = (path) => new Promise((resolve, reject) => mkdirp(path, (err, res) => err ? reject(err) : resolve(res)));
const fsp = fs.promises;
const fsmtime = (path) => fsp.stat(path).then(stats => stats.mtime, () => null);
const toAbsolutePath = (path, base) => {
    if (fspath.isAbsolute(path)) {
        return fspath.normalize(path);
    }
    return fspath.normalize(fspath.join(base, path));
};
const findAllDependencies = (ast, action) => {
    return traverse_1.default(ast, {
        ImportDeclaration(path) {
            const node = path.node;
            action(node.source.value);
        },
        ExportDeclaration(path) {
            const node = path.node;
            if ('ExportNamedDeclaration' === node.type) {
                const n = node;
                if (n.source) {
                    action(n.source.value);
                }
            }
        }
    });
};
const keyDeepDependencies = 'polymer.deep.depepndencies';
async function resolveDeep(targetRoot, npmRoot, context, toCopy, path) {
    const mtime = await fsmtime(path);
    if (!mtime) {
        throw new Error(`failed to get mtime for ${path}`);
    }
    let deps;
    const entry = await context.storage.getObject(`!${keyDeepDependencies}!${path}`);
    if (entry && entry.mtime >= mtime) {
        deps = entry.deps;
    }
    else {
        // already parsed?
        let ast;
        const entry = await context.storage.getObject(`!polymer.deep.ast!${path}`);
        if (entry && entry.mtime >= mtime) {
            ast = entry.ast;
        }
        else {
            const babelOptions = {
                filename: path,
                ast: true,
                root: npmRoot,
                rootMode: 'root',
                parserOpts: {
                    sourceType: 'module'
                }
            };
            const sourceCode = await context.getContents(dopees_chain_1.Task.file(path), 'utf-8');
            ast = await babel.parseAsync(sourceCode, babelOptions);
            await context.storage.setObject(`!polymer.deep.ast!${path}`, { mtime, ast });
        }
        // get dependencies
        deps = [];
        findAllDependencies(ast, dep => deps.push(dep));
        await context.storage.setObject(`!${keyDeepDependencies}!${path}`, { mtime, deps });
    }
    // process dependencies
    const deepDependencies = [];
    for (const localPath of deps) {
        if (localPath.startsWith('./') || localPath.startsWith('../')) {
            // in-package dependency
            let source = fspath.normalize(fspath.join(fspath.dirname(path), localPath));
            if (!source.endsWith('.js')) {
                source += '.js';
            }
            if (!toCopy.some(e => e.source === source)) {
                const target = fspath.normalize(fspath.join(targetRoot, fspath.relative(npmRoot, source)));
                toCopy.push({ source, target });
                deepDependencies.push(source);
            }
        }
        else {
            // external dependency
            let source = fspath.normalize(fspath.join(npmRoot, localPath));
            if (!source.endsWith('.js')) {
                source += '.js';
            }
            if (!toCopy.some(e => e.source === source)) {
                let target = fspath.normalize(fspath.join(targetRoot, fspath.relative(npmRoot, source)));
                // same folder dependencies must start with './'
                if (!target.startsWith('..')) {
                    target = './' + target;
                }
                toCopy.push({ source, target });
                deepDependencies.push(source);
            }
        }
    }
    // trigger deep resolve
    await Promise.all(deepDependencies.map(path => resolveDeep(targetRoot, npmRoot, context, toCopy, path)));
}
function unique(source) {
    const result = [];
    for (const item of source) {
        if (!result.some(i => i === item)) {
            result.push(item);
        }
    }
    return result;
}
function deploy(opts) {
    const { targetRoot, buildTaskName, allDependenciesKey } = opts;
    return async (task, context) => {
        if (task.name instanceof dopees_chain_1.LogicalName && task.name.name === buildTaskName) {
            const deps = await context.storage.getObject(allDependenciesKey);
            if (!deps) {
                throw new Error('no dependencies has been populated');
            }
            const root = context.basePath;
            const npmRoot = fspath.join(root, 'node_modules');
            // flatten dependencies
            const toCopy = [];
            // const imports: Array<{ name: string, target: string }> = [];
            context.log('deploy', task, 'resolving source dependencies...');
            const allSources = unique(deps.map(dep => dep.source));
            for (const entry of deps) {
                for (const dep of entry.dependencies) {
                    const possibleSource = fspath.normalize(fspath.join(fspath.dirname(entry.source), dep));
                    if (!allSources.some(x => x === possibleSource)) {
                        const dependency = fspath.relative(targetRoot, possibleSource);
                        let mtime;
                        // try js in modules
                        let candidate = fspath.join(npmRoot, dependency);
                        mtime = await fsmtime(candidate);
                        if (!mtime) {
                            throw new Error(`unable to resolve ${dependency}`);
                        }
                        const target = fspath.join(targetRoot, dependency);
                        toCopy.push({
                            source: candidate,
                            target
                        });
                    }
                }
            }
            // context.log('deploy', task, 'done updating dependency imports');
            context.log('deploy', task, 'done resolving source dependencies');
            // resolve deep dependencies
            context.log('deploy', task, 'resolving deep dependencies...');
            await Promise.all(toCopy.map(e => resolveDeep(targetRoot, npmRoot, context, toCopy, e.source)));
            context.log('deploy', task, 'done resolving deep dependencies');
            // copy dependencies
            context.log('deploy', task, 'copying dependencies...');
            const created = new Set();
            await Promise.all(toCopy.map(async (e) => {
                const folder = fspath.dirname(e.target);
                if (!created.has(folder)) {
                    await mkdirrec(folder);
                    created.add(folder);
                }
                await fsp.copyFile(e.source, e.target);
            }));
            context.log('deploy', task, 'done copying dependencies');
        }
    };
}
class PolymerProject {
    constructor(config) {
        this.taskName = 'dopees-polymer';
        this.cwd = config.cwd || process.cwd();
        this.buildRoot = toAbsolutePath(config.buildRoot || './.build', this.cwd);
        this.sourceRoot = toAbsolutePath(config.sourceRoot, this.cwd);
        this.targetRoot = toAbsolutePath(config.targetRoot, this.cwd);
        this.application = config.application !== false;
    }
    async getTargets() {
        const targets = [];
        const traverse = async (subpath) => {
            const names = await fsp.readdir(fspath.join(this.sourceRoot, subpath));
            for (const name of names) {
                const sourcePath = fspath.normalize(fspath.join(this.sourceRoot, subpath, name));
                const stats = await fsp.stat(sourcePath).catch(() => null);
                if (stats) {
                    if (stats.isDirectory()) {
                        await traverse(fspath.normalize(fspath.join(subpath, name)));
                    }
                    else if (sourcePath.endsWith('.ts') && !sourcePath.endsWith('.d.ts')) {
                        const targetPath = fspath.normalize(fspath.join(this.targetRoot, fspath.relative(this.sourceRoot, sourcePath))).replace(/\.ts$/, '.js');
                        targets.push({ path: targetPath, base: this.cwd });
                    }
                }
            }
        };
        await traverse('.');
        return targets;
    }
    createExecutor() {
        const pugSourceResolver = dopees_chain_1.ReversePathResolver.from({
            sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
            targetRoot: fspath.relative(this.cwd, this.buildRoot),
            sourceExt: 'pug',
            targetExt: 'html'
        });
        const executors = [
            dopees_chain_sass_1.sass({
                sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
                targetRoot: fspath.relative(this.cwd, this.buildRoot),
                sourceExt: 'scss',
                targetExt: 'css',
                outputStyle: 'compressed'
            }),
            dopees_chain_pug_1.pug({
                inlineCss: true,
                targetRoot: fspath.relative(this.cwd, this.buildRoot),
                sourceResolver: (path, base) => {
                    const source = pugSourceResolver(path, base);
                    if (!source) {
                        throw new Error(`unable to resolve source for ${path} (base = ${base})`);
                    }
                    return source;
                }
            }),
            dopees_chain_typescript_1.dopees({
                sourceRoot: fspath.relative(this.cwd, this.sourceRoot),
                buildRoot: fspath.relative(this.cwd, this.buildRoot),
                targetRoot: fspath.relative(this.cwd, this.targetRoot),
                saveAllDependencies: true,
                allDependenciesKey: 'dopees.polymer.dependencies',
                updateExternalImports: this.application
            }),
            async (task, context) => {
                if (task.name instanceof dopees_chain_1.LogicalName && task.name.name === this.taskName) {
                    const targets = await this.getTargets();
                    await Promise.all(targets.map(target => context.execute(dopees_chain_1.Task.file(target.path, target.base))));
                }
            }
        ];
        if (this.application) {
            executors.push(deploy({
                targetRoot: this.targetRoot,
                allDependenciesKey: 'dopees.polymer.dependencies',
                buildTaskName: this.taskName
            }));
        }
        return dopees_chain_1.Executors.combine(executors);
    }
}
exports.PolymerProject = PolymerProject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9seW1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wb2x5bWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QiwrQ0FBb0c7QUFDcEcseURBQXlDO0FBQ3pDLHVEQUF1QztBQUN2QyxxRUFBa0U7QUFFbEUscUNBQXFDO0FBQ3JDLDhDQUF1QztBQUN2QyxpQ0FBaUM7QUFFakMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxJQUFZLEVBQXdCLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV4SixNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDO0FBRXhCLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFXeEYsTUFBTSxjQUFjLEdBQUcsQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLEVBQUU7SUFDcEQsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzNCLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMvQjtJQUNELE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ25E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QUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDaEc7WUFDSCxDQUFDO1NBQ0YsQ0FBQztRQUNGLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNwQixTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDcEIsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO2dCQUMzQixrQkFBa0IsRUFBRSw2QkFBNkI7Z0JBQ2pELGFBQWEsRUFBRSxJQUFJLENBQUMsUUFBUTthQUM3QixDQUFDLENBQUMsQ0FBQztTQUNMO1FBQ0QsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBQ0Y7QUF6RkQsd0NBeUZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnNwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgRXhlY3V0b3IsIEV4ZWN1dG9ycywgUmV2ZXJzZVBhdGhSZXNvbHZlciwgVGFzaywgQ29udGV4dCwgTG9naWNhbE5hbWUgfSBmcm9tICdkb3BlZXMtY2hhaW4nO1xuaW1wb3J0IHsgc2FzcyB9IGZyb20gJ2RvcGVlcy1jaGFpbi1zYXNzJztcbmltcG9ydCB7IHB1ZyB9IGZyb20gJ2RvcGVlcy1jaGFpbi1wdWcnO1xuaW1wb3J0IHsgZG9wZWVzLCBEZXBlbmRlbmN5RW50cnkgfSBmcm9tICdkb3BlZXMtY2hhaW4tdHlwZXNjcmlwdCc7XG5pbXBvcnQgKiBhcyB0IGZyb20gJ0BiYWJlbC90eXBlcyc7XG5pbXBvcnQgKiBhcyBiYWJlbCBmcm9tICdAYmFiZWwvY29yZSc7XG5pbXBvcnQgdHJhdmVyc2UgZnJvbSAnQGJhYmVsL3RyYXZlcnNlJztcbmltcG9ydCAqIGFzIG1rZGlycCBmcm9tICdta2RpcnAnO1xuXG5jb25zdCBta2RpcnJlYyA9IChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPG1rZGlycC5NYWRlPiA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBta2RpcnAocGF0aCwgKGVyciwgcmVzKSA9PiBlcnIgPyByZWplY3QoZXJyKSA6IHJlc29sdmUocmVzKSkpO1xuXG5jb25zdCBmc3AgPSBmcy5wcm9taXNlcztcblxuY29uc3QgZnNtdGltZSA9IChwYXRoOiBzdHJpbmcpID0+IGZzcC5zdGF0KHBhdGgpLnRoZW4oc3RhdHMgPT4gc3RhdHMubXRpbWUsICgpID0+IG51bGwpO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICBzb3VyY2VSb290OiBzdHJpbmc7XG4gIHRhcmdldFJvb3Q6IHN0cmluZztcbiAgYnVpbGRSb290Pzogc3RyaW5nO1xuICBjd2Q/OiBzdHJpbmc7XG4gIC8qKiBXaGVuIF90cnVlXyBhbGwgZGVlcCBkZXBlbmRlbmNpZXMgYXJlIHJld3JpdHRlbiB3aXRoIHJlc3BvY3QgdG8gdGhlIHRhcmdldCBkaXJlY3RvcnkuICovXG4gIGFwcGxpY2F0aW9uPzogYm9vbGVhbjtcbn1cblxuY29uc3QgdG9BYnNvbHV0ZVBhdGggPSAocGF0aDogc3RyaW5nLCBiYXNlOiBzdHJpbmcpID0+IHtcbiAgaWYgKGZzcGF0aC5pc0Fic29sdXRlKHBhdGgpKSB7XG4gICAgcmV0dXJuIGZzcGF0aC5ub3JtYWxpemUocGF0aCk7XG4gIH1cbiAgcmV0dXJuIGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4oYmFzZSwgcGF0aCkpO1xufVxuXG5pbnRlcmZhY2UgVGFyZ2V0IHtcbiAgcGF0aDogc3RyaW5nO1xuICBiYXNlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBEZXBsb3lPcHRpb25zIHtcbiAgdGFyZ2V0Um9vdDogc3RyaW5nO1xuICBidWlsZFRhc2tOYW1lOiBzdHJpbmc7XG4gIGFsbERlcGVuZGVuY2llc0tleTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgRGVlcERlcGVuZGVuY2llcyB7XG4gIG10aW1lOiBEYXRlLFxuICBkZXBzOiBzdHJpbmdbXVxufVxuXG5pbnRlcmZhY2UgQ2FjaGVkQXN0IHtcbiAgbXRpbWU6IERhdGUsXG4gIGFzdDogdC5Ob2RlXG59XG5cbmNvbnN0IGZpbmRBbGxEZXBlbmRlbmNpZXMgPSAoYXN0OiB0Lk5vZGUsIGFjdGlvbjogKHNvdXJjZTogc3RyaW5nKSA9PiB2b2lkKSA9PiB7XG4gIHJldHVybiB0cmF2ZXJzZShhc3QsIHtcbiAgICBJbXBvcnREZWNsYXJhdGlvbihwYXRoKSB7XG4gICAgICBjb25zdCBub2RlID0gcGF0aC5ub2RlO1xuICAgICAgYWN0aW9uKG5vZGUuc291cmNlLnZhbHVlKTtcbiAgICB9LFxuICAgIEV4cG9ydERlY2xhcmF0aW9uKHBhdGgpIHtcbiAgICAgIGNvbnN0IG5vZGUgPSBwYXRoLm5vZGU7XG4gICAgICBpZiAoJ0V4cG9ydE5hbWVkRGVjbGFyYXRpb24nID09PSBub2RlLnR5cGUpIHtcbiAgICAgICAgY29uc3QgbiA9IDx0LkV4cG9ydE5hbWVkRGVjbGFyYXRpb24+bm9kZTtcbiAgICAgICAgaWYgKG4uc291cmNlKSB7XG4gICAgICAgICAgYWN0aW9uKG4uc291cmNlLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuXG5jb25zdCBrZXlEZWVwRGVwZW5kZW5jaWVzID0gJ3BvbHltZXIuZGVlcC5kZXBlcG5kZW5jaWVzJztcblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZURlZXAodGFyZ2V0Um9vdDogc3RyaW5nLCBucG1Sb290OiBzdHJpbmcsIGNvbnRleHQ6IENvbnRleHQsIHRvQ29weTogQXJyYXk8eyBzb3VyY2U6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcgfT4sIHBhdGg6IHN0cmluZykge1xuICBjb25zdCBtdGltZSA9IGF3YWl0IGZzbXRpbWUocGF0aCk7XG4gIGlmICghbXRpbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGZhaWxlZCB0byBnZXQgbXRpbWUgZm9yICR7cGF0aH1gKTtcbiAgfVxuICBsZXQgZGVwczogc3RyaW5nW107XG4gIGNvbnN0IGVudHJ5ID0gYXdhaXQgY29udGV4dC5zdG9yYWdlLmdldE9iamVjdDxEZWVwRGVwZW5kZW5jaWVzPihgISR7a2V5RGVlcERlcGVuZGVuY2llc30hJHtwYXRofWApO1xuICBpZiAoZW50cnkgJiYgZW50cnkubXRpbWUgPj0gbXRpbWUpIHtcbiAgICBkZXBzID0gZW50cnkuZGVwcztcbiAgfSBlbHNlIHtcbiAgICAvLyBhbHJlYWR5IHBhcnNlZD9cbiAgICBsZXQgYXN0OiB0Lk5vZGU7XG4gICAgY29uc3QgZW50cnkgPSBhd2FpdCBjb250ZXh0LnN0b3JhZ2UuZ2V0T2JqZWN0PENhY2hlZEFzdD4oYCFwb2x5bWVyLmRlZXAuYXN0ISR7cGF0aH1gKTtcbiAgICBpZiAoZW50cnkgJiYgZW50cnkubXRpbWUgPj0gbXRpbWUpIHtcbiAgICAgIGFzdCA9IGVudHJ5LmFzdDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYmFiZWxPcHRpb25zIDogYmFiZWwuT3B0aW9ucyA9IHtcbiAgICAgICAgZmlsZW5hbWU6IHBhdGgsXG4gICAgICAgIGFzdDogdHJ1ZSxcbiAgICAgICAgcm9vdDogbnBtUm9vdCxcbiAgICAgICAgcm9vdE1vZGU6ICdyb290JyxcbiAgICAgICAgcGFyc2VyT3B0czoge1xuICAgICAgICAgIHNvdXJjZVR5cGU6ICdtb2R1bGUnXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBjb25zdCBzb3VyY2VDb2RlID0gYXdhaXQgY29udGV4dC5nZXRDb250ZW50cyhUYXNrLmZpbGUocGF0aCksICd1dGYtOCcpO1xuICAgICAgYXN0ID0gYXdhaXQgYmFiZWwucGFyc2VBc3luYyhzb3VyY2VDb2RlLCBiYWJlbE9wdGlvbnMpO1xuICAgICAgYXdhaXQgY29udGV4dC5zdG9yYWdlLnNldE9iamVjdChgIXBvbHltZXIuZGVlcC5hc3QhJHtwYXRofWAsIDxDYWNoZWRBc3Q+eyBtdGltZSwgYXN0IH0pO1xuICAgIH1cbiAgICAvLyBnZXQgZGVwZW5kZW5jaWVzXG4gICAgZGVwcyA9IFtdO1xuICAgIGZpbmRBbGxEZXBlbmRlbmNpZXMoYXN0LCBkZXAgPT4gZGVwcy5wdXNoKGRlcCkpO1xuICAgIGF3YWl0IGNvbnRleHQuc3RvcmFnZS5zZXRPYmplY3QoYCEke2tleURlZXBEZXBlbmRlbmNpZXN9ISR7cGF0aH1gLCA8RGVlcERlcGVuZGVuY2llcz57IG10aW1lLCBkZXBzIH0pO1xuICB9XG4gIC8vIHByb2Nlc3MgZGVwZW5kZW5jaWVzXG4gIGNvbnN0IGRlZXBEZXBlbmRlbmNpZXM6IHN0cmluZ1tdID0gW107XG4gIGZvciAoY29uc3QgbG9jYWxQYXRoIG9mIGRlcHMpIHtcbiAgICBpZiAobG9jYWxQYXRoLnN0YXJ0c1dpdGgoJy4vJykgfHwgbG9jYWxQYXRoLnN0YXJ0c1dpdGgoJy4uLycpKSB7XG4gICAgICAvLyBpbi1wYWNrYWdlIGRlcGVuZGVuY3lcbiAgICAgIGxldCBzb3VyY2UgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKGZzcGF0aC5kaXJuYW1lKHBhdGgpLCBsb2NhbFBhdGgpKTtcbiAgICAgIGlmICghc291cmNlLmVuZHNXaXRoKCcuanMnKSkge1xuICAgICAgICBzb3VyY2UgKz0gJy5qcyc7XG4gICAgICB9XG4gICAgICBpZiAoIXRvQ29weS5zb21lKGUgPT4gZS5zb3VyY2UgPT09IHNvdXJjZSkpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbih0YXJnZXRSb290LCBmc3BhdGgucmVsYXRpdmUobnBtUm9vdCwgc291cmNlKSkpO1xuICAgICAgICB0b0NvcHkucHVzaCh7IHNvdXJjZSwgdGFyZ2V0IH0pO1xuICAgICAgICBkZWVwRGVwZW5kZW5jaWVzLnB1c2goc291cmNlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gZXh0ZXJuYWwgZGVwZW5kZW5jeVxuICAgICAgbGV0IHNvdXJjZSA9IGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4obnBtUm9vdCwgbG9jYWxQYXRoKSk7XG4gICAgICBpZiAoIXNvdXJjZS5lbmRzV2l0aCgnLmpzJykpIHtcbiAgICAgICAgc291cmNlICs9ICcuanMnO1xuICAgICAgfVxuICAgICAgaWYgKCF0b0NvcHkuc29tZShlID0+IGUuc291cmNlID09PSBzb3VyY2UpKSB7XG4gICAgICAgIGxldCB0YXJnZXQgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKHRhcmdldFJvb3QsIGZzcGF0aC5yZWxhdGl2ZShucG1Sb290LCBzb3VyY2UpKSk7XG4gICAgICAgIC8vIHNhbWUgZm9sZGVyIGRlcGVuZGVuY2llcyBtdXN0IHN0YXJ0IHdpdGggJy4vJ1xuICAgICAgICBpZiAoIXRhcmdldC5zdGFydHNXaXRoKCcuLicpKSB7XG4gICAgICAgICAgdGFyZ2V0ID0gJy4vJyArIHRhcmdldDtcbiAgICAgICAgfVxuICAgICAgICB0b0NvcHkucHVzaCh7IHNvdXJjZSwgdGFyZ2V0IH0pO1xuICAgICAgICBkZWVwRGVwZW5kZW5jaWVzLnB1c2goc291cmNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8gdHJpZ2dlciBkZWVwIHJlc29sdmVcbiAgYXdhaXQgUHJvbWlzZS5hbGwoZGVlcERlcGVuZGVuY2llcy5tYXAocGF0aCA9PiByZXNvbHZlRGVlcCh0YXJnZXRSb290LCBucG1Sb290LCBjb250ZXh0LCB0b0NvcHksIHBhdGgpKSk7XG59XG5cbmZ1bmN0aW9uIHVuaXF1ZTxUPihzb3VyY2U6IFRbXSk6IFRbXSB7XG4gIGNvbnN0IHJlc3VsdDogVFtdID0gW107XG4gIGZvciAoY29uc3QgaXRlbSBvZiBzb3VyY2UpIHtcbiAgICBpZiAoIXJlc3VsdC5zb21lKGkgPT4gaSA9PT0gaXRlbSkpIHtcbiAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBkZXBsb3kob3B0czogRGVwbG95T3B0aW9ucyk6IEV4ZWN1dG9yIHtcbiAgY29uc3QgeyB0YXJnZXRSb290LCBidWlsZFRhc2tOYW1lLCBhbGxEZXBlbmRlbmNpZXNLZXkgfSA9IG9wdHM7XG4gIHJldHVybiBhc3luYyAodGFzazogVGFzaywgY29udGV4dDogQ29udGV4dCkgPT4ge1xuICAgIGlmICh0YXNrLm5hbWUgaW5zdGFuY2VvZiBMb2dpY2FsTmFtZSAmJiB0YXNrLm5hbWUubmFtZSA9PT0gYnVpbGRUYXNrTmFtZSkge1xuICAgICAgY29uc3QgZGVwcyA9IGF3YWl0IGNvbnRleHQuc3RvcmFnZS5nZXRPYmplY3Q8RGVwZW5kZW5jeUVudHJ5W10+KGFsbERlcGVuZGVuY2llc0tleSk7XG4gICAgICBpZiAoIWRlcHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdubyBkZXBlbmRlbmNpZXMgaGFzIGJlZW4gcG9wdWxhdGVkJyk7XG4gICAgICB9XG4gICAgICBjb25zdCByb290ID0gY29udGV4dC5iYXNlUGF0aDtcbiAgICAgIGNvbnN0IG5wbVJvb3QgPSBmc3BhdGguam9pbihyb290LCAnbm9kZV9tb2R1bGVzJyk7XG4gICAgICAvLyBmbGF0dGVuIGRlcGVuZGVuY2llc1xuICAgICAgY29uc3QgdG9Db3B5OiBBcnJheTx7IHNvdXJjZTogc3RyaW5nLCB0YXJnZXQ6IHN0cmluZyB9PiA9IFtdO1xuICAgICAgLy8gY29uc3QgaW1wb3J0czogQXJyYXk8eyBuYW1lOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nIH0+ID0gW107XG4gICAgICBjb250ZXh0LmxvZygnZGVwbG95JywgdGFzaywgJ3Jlc29sdmluZyBzb3VyY2UgZGVwZW5kZW5jaWVzLi4uJyk7XG4gICAgICBjb25zdCBhbGxTb3VyY2VzID0gdW5pcXVlKGRlcHMubWFwKGRlcCA9PiBkZXAuc291cmNlKSk7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGRlcHMpIHtcbiAgICAgICAgZm9yIChjb25zdCBkZXAgb2YgZW50cnkuZGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgY29uc3QgcG9zc2libGVTb3VyY2UgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKGZzcGF0aC5kaXJuYW1lKGVudHJ5LnNvdXJjZSksIGRlcCkpO1xuICAgICAgICAgIGlmICghYWxsU291cmNlcy5zb21lKHggPT4geCA9PT0gcG9zc2libGVTb3VyY2UpKSB7XG4gICAgICAgICAgICBjb25zdCBkZXBlbmRlbmN5ID0gZnNwYXRoLnJlbGF0aXZlKHRhcmdldFJvb3QsIHBvc3NpYmxlU291cmNlKTtcbiAgICAgICAgICAgIGxldCBtdGltZSA6IERhdGV8bnVsbDtcbiAgICAgICAgICAgIC8vIHRyeSBqcyBpbiBtb2R1bGVzXG4gICAgICAgICAgICBsZXQgY2FuZGlkYXRlID0gZnNwYXRoLmpvaW4obnBtUm9vdCwgZGVwZW5kZW5jeSk7XG4gICAgICAgICAgICBtdGltZSA9IGF3YWl0IGZzbXRpbWUoY2FuZGlkYXRlKTtcbiAgICAgICAgICAgIGlmICghbXRpbWUpIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gcmVzb2x2ZSAke2RlcGVuZGVuY3l9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBmc3BhdGguam9pbih0YXJnZXRSb290LCBkZXBlbmRlbmN5KTtcbiAgICAgICAgICAgIHRvQ29weS5wdXNoKHtcbiAgICAgICAgICAgICAgc291cmNlOiBjYW5kaWRhdGUsXG4gICAgICAgICAgICAgIHRhcmdldFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBjb250ZXh0LmxvZygnZGVwbG95JywgdGFzaywgJ2RvbmUgdXBkYXRpbmcgZGVwZW5kZW5jeSBpbXBvcnRzJyk7XG4gICAgICBjb250ZXh0LmxvZygnZGVwbG95JywgdGFzaywgJ2RvbmUgcmVzb2x2aW5nIHNvdXJjZSBkZXBlbmRlbmNpZXMnKTtcbiAgICAgIC8vIHJlc29sdmUgZGVlcCBkZXBlbmRlbmNpZXNcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAncmVzb2x2aW5nIGRlZXAgZGVwZW5kZW5jaWVzLi4uJyk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh0b0NvcHkubWFwKGUgPT4gcmVzb2x2ZURlZXAodGFyZ2V0Um9vdCwgbnBtUm9vdCwgY29udGV4dCwgdG9Db3B5LCBlLnNvdXJjZSkpKTtcbiAgICAgIGNvbnRleHQubG9nKCdkZXBsb3knLCB0YXNrLCAnZG9uZSByZXNvbHZpbmcgZGVlcCBkZXBlbmRlbmNpZXMnKTtcbiAgICAgIC8vIGNvcHkgZGVwZW5kZW5jaWVzXG4gICAgICBjb250ZXh0LmxvZygnZGVwbG95JywgdGFzaywgJ2NvcHlpbmcgZGVwZW5kZW5jaWVzLi4uJyk7XG4gICAgICBjb25zdCBjcmVhdGVkID0gbmV3IFNldCgpO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodG9Db3B5Lm1hcChhc3luYyBlID0+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyID0gZnNwYXRoLmRpcm5hbWUoZS50YXJnZXQpO1xuICAgICAgICBpZiAoIWNyZWF0ZWQuaGFzKGZvbGRlcikpIHtcbiAgICAgICAgICBhd2FpdCBta2RpcnJlYyhmb2xkZXIpO1xuICAgICAgICAgIGNyZWF0ZWQuYWRkKGZvbGRlcik7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgZnNwLmNvcHlGaWxlKGUuc291cmNlLCBlLnRhcmdldCk7XG4gICAgICB9KSk7XG4gICAgICBjb250ZXh0LmxvZygnZGVwbG95JywgdGFzaywgJ2RvbmUgY29weWluZyBkZXBlbmRlbmNpZXMnKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBvbHltZXJQcm9qZWN0IHtcbiAgc291cmNlUm9vdDogc3RyaW5nO1xuICB0YXJnZXRSb290OiBzdHJpbmc7XG4gIGJ1aWxkUm9vdDogc3RyaW5nO1xuICBjd2Q6IHN0cmluZztcbiAgYXBwbGljYXRpb246IGJvb2xlYW47XG4gIHRhc2tOYW1lID0gJ2RvcGVlcy1wb2x5bWVyJztcbiAgY29uc3RydWN0b3IoY29uZmlnOiBPcHRpb25zKSB7XG4gICAgdGhpcy5jd2QgPSBjb25maWcuY3dkIHx8IHByb2Nlc3MuY3dkKCk7XG4gICAgdGhpcy5idWlsZFJvb3QgPSB0b0Fic29sdXRlUGF0aChjb25maWcuYnVpbGRSb290IHx8ICcuLy5idWlsZCcsIHRoaXMuY3dkKTtcbiAgICB0aGlzLnNvdXJjZVJvb3QgPSB0b0Fic29sdXRlUGF0aChjb25maWcuc291cmNlUm9vdCwgdGhpcy5jd2QpO1xuICAgIHRoaXMudGFyZ2V0Um9vdCA9IHRvQWJzb2x1dGVQYXRoKGNvbmZpZy50YXJnZXRSb290LCB0aGlzLmN3ZCk7XG4gICAgdGhpcy5hcHBsaWNhdGlvbiA9IGNvbmZpZy5hcHBsaWNhdGlvbiAhPT0gZmFsc2U7XG4gIH1cbiAgcHJpdmF0ZSBhc3luYyBnZXRUYXJnZXRzKCkge1xuICAgIGNvbnN0IHRhcmdldHMgOiBUYXJnZXRbXSA9IFtdO1xuICAgIGNvbnN0IHRyYXZlcnNlID0gYXN5bmMgKHN1YnBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmFtZXMgPSBhd2FpdCBmc3AucmVhZGRpcihmc3BhdGguam9pbih0aGlzLnNvdXJjZVJvb3QsIHN1YnBhdGgpKTtcbiAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBuYW1lcykge1xuICAgICAgICBjb25zdCBzb3VyY2VQYXRoID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbih0aGlzLnNvdXJjZVJvb3QsIHN1YnBhdGgsIG5hbWUpKTtcbiAgICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmc3Auc3RhdChzb3VyY2VQYXRoKS5jYXRjaCgoKSA9PiBudWxsKTtcbiAgICAgICAgaWYgKHN0YXRzKSB7XG4gICAgICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRyYXZlcnNlKGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4oc3VicGF0aCwgbmFtZSkpKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZVBhdGguZW5kc1dpdGgoJy50cycpICYmICFzb3VyY2VQYXRoLmVuZHNXaXRoKCcuZC50cycpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRQYXRoID0gZnNwYXRoLm5vcm1hbGl6ZShcbiAgICAgICAgICAgICAgZnNwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgdGhpcy50YXJnZXRSb290LFxuICAgICAgICAgICAgICAgIGZzcGF0aC5yZWxhdGl2ZSh0aGlzLnNvdXJjZVJvb3QsIHNvdXJjZVBhdGgpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkucmVwbGFjZSgvXFwudHMkLywgJy5qcycpO1xuICAgICAgICAgICAgdGFyZ2V0cy5wdXNoKHsgcGF0aDogdGFyZ2V0UGF0aCwgYmFzZTogdGhpcy5jd2QgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICBhd2FpdCB0cmF2ZXJzZSgnLicpO1xuICAgIHJldHVybiB0YXJnZXRzO1xuICB9XG4gIGNyZWF0ZUV4ZWN1dG9yKCk6IEV4ZWN1dG9yIHtcbiAgICBjb25zdCBwdWdTb3VyY2VSZXNvbHZlciA9IFJldmVyc2VQYXRoUmVzb2x2ZXIuZnJvbSh7XG4gICAgICBzb3VyY2VSb290OiBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMuc291cmNlUm9vdCksXG4gICAgICB0YXJnZXRSb290OiBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMuYnVpbGRSb290KSxcbiAgICAgIHNvdXJjZUV4dDogJ3B1ZycsXG4gICAgICB0YXJnZXRFeHQ6ICdodG1sJ1xuICAgIH0pO1xuICAgIGNvbnN0IGV4ZWN1dG9ycyA9IFtcbiAgICAgIHNhc3Moe1xuICAgICAgICBzb3VyY2VSb290OiBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMuc291cmNlUm9vdCksXG4gICAgICAgIHRhcmdldFJvb3Q6IGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5idWlsZFJvb3QpLFxuICAgICAgICBzb3VyY2VFeHQ6ICdzY3NzJyxcbiAgICAgICAgdGFyZ2V0RXh0OiAnY3NzJyxcbiAgICAgICAgb3V0cHV0U3R5bGU6ICdjb21wcmVzc2VkJ1xuICAgICAgfSksXG4gICAgICBwdWcoe1xuICAgICAgICBpbmxpbmVDc3M6IHRydWUsXG4gICAgICAgIHRhcmdldFJvb3Q6IGZzcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgdGhpcy5idWlsZFJvb3QpLFxuICAgICAgICBzb3VyY2VSZXNvbHZlcjogKHBhdGg6IHN0cmluZywgYmFzZT86IHN0cmluZykgPT4ge1xuICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IHB1Z1NvdXJjZVJlc29sdmVyKHBhdGgsIGJhc2UpO1xuICAgICAgICAgIGlmICghc291cmNlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byByZXNvbHZlIHNvdXJjZSBmb3IgJHtwYXRofSAoYmFzZSA9ICR7YmFzZX0pYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBzb3VyY2U7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZG9wZWVzKHtcbiAgICAgICAgc291cmNlUm9vdDogZnNwYXRoLnJlbGF0aXZlKHRoaXMuY3dkLCB0aGlzLnNvdXJjZVJvb3QpLFxuICAgICAgICBidWlsZFJvb3Q6ICBmc3BhdGgucmVsYXRpdmUodGhpcy5jd2QsIHRoaXMuYnVpbGRSb290KSxcbiAgICAgICAgdGFyZ2V0Um9vdDogZnNwYXRoLnJlbGF0aXZlKHRoaXMuY3dkLCB0aGlzLnRhcmdldFJvb3QpLFxuICAgICAgICBzYXZlQWxsRGVwZW5kZW5jaWVzOiB0cnVlLFxuICAgICAgICBhbGxEZXBlbmRlbmNpZXNLZXk6ICdkb3BlZXMucG9seW1lci5kZXBlbmRlbmNpZXMnLFxuICAgICAgICB1cGRhdGVFeHRlcm5hbEltcG9ydHM6IHRoaXMuYXBwbGljYXRpb25cbiAgICAgIH0pLFxuICAgICAgYXN5bmMgKHRhc2s6IFRhc2ssIGNvbnRleHQ6IENvbnRleHQpID0+IHtcbiAgICAgICAgaWYgKHRhc2submFtZSBpbnN0YW5jZW9mIExvZ2ljYWxOYW1lICYmIHRhc2submFtZS5uYW1lID09PSB0aGlzLnRhc2tOYW1lKSB7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0cyA9IGF3YWl0IHRoaXMuZ2V0VGFyZ2V0cygpO1xuICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRhcmdldHMubWFwKHRhcmdldCA9PiBjb250ZXh0LmV4ZWN1dGUoVGFzay5maWxlKHRhcmdldC5wYXRoLCB0YXJnZXQuYmFzZSkpKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBdO1xuICAgIGlmICh0aGlzLmFwcGxpY2F0aW9uKSB7XG4gICAgICBleGVjdXRvcnMucHVzaChkZXBsb3koe1xuICAgICAgICB0YXJnZXRSb290OiB0aGlzLnRhcmdldFJvb3QsXG4gICAgICAgIGFsbERlcGVuZGVuY2llc0tleTogJ2RvcGVlcy5wb2x5bWVyLmRlcGVuZGVuY2llcycsXG4gICAgICAgIGJ1aWxkVGFza05hbWU6IHRoaXMudGFza05hbWVcbiAgICAgIH0pKTtcbiAgICB9XG4gICAgcmV0dXJuIEV4ZWN1dG9ycy5jb21iaW5lKGV4ZWN1dG9ycyk7XG4gIH1cbn0iXX0=